<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="preconnect" href="https://pagead2.googlesyndication.com">
    <link rel="icon" type="image/png" href="../ASSETS/favicon.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compress PDF | DocLite</title>
    <link rel="canonical" href="https://doclite.me/tools/compress-pdf-backup.html">
    <link rel="stylesheet" href="../css/global.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css" media="print" onload="this.media='all'"><noscript><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@tabler/icons-webfont@latest/tabler-icons.min.css"></noscript>
    <script>
        // Lazy load AdSense
        setTimeout(function() {
            var script = document.createElement('script');
            script.src = "https://pagead2.googlesyndication.com/pagead/js/adsbygoogle.js?client=ca-pub-7592510129424613";
            script.crossOrigin = "anonymous";
            script.async = true;
            document.head.appendChild(script);
        }, 3000); // Delay 3 seconds
    </script>
<meta property="og:image" content="https://doclite.me/ASSETS/favicon.png">
    <link rel="apple-touch-icon" href="https://doclite.me/ASSETS/favicon.png">
</head>
<body>
    <nav class="navbar">
        <div class="navbar-container">
            <a href="../index.html" class="navbar-logo">DocLite</a>
            <ul class="navbar-menu">
                <li><a href="../index.html" class="navbar-link">Home</a></li>
                <li><a href="../index.html#pdf-tools" class="navbar-link">PDF Tools</a></li>
                <li><a href="../index.html#image-tools" class="navbar-link">Image Tools</a></li>
                <li><a href="../index.html#text-tools" class="navbar-link">Text Tools</a></li>
                <li><a href="../index.html#dev-tools" class="navbar-link">Developer</a></li>
            </ul>
        </div>
    </nav>
    <div class="ad-slot">Advertisement Space</div>

    <div class="tool-page">
        <div class="tool-header">
            <div class="tool-header-icon"><i class="ti ti-arrows-minimize"></i></div>
            <h1>Compress PDF</h1>
            <p class="tool-header-description">Reduce PDF file size while maintaining quality</p>
        </div>

        <div id="uploadArea"></div>
        <div id="fileListSection" class="hidden"></div>
        
        <div id="controlsSection" class="controls hidden" style="margin:2rem auto;max-width:900px;">
            <h3 style="text-align:center;margin-bottom:1.75rem;font-size:1.75rem;font-weight:800;letter-spacing:-0.5px;">Compression Level</h3>
            <div id="levelsGrid" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(140px,1fr));gap:1rem;">
                <!-- Levels injected by script -->
            </div>
            <div style="margin-top:1.5rem;text-align:center;font-size:0.9rem;color:#4a5568;font-weight:600;" id="levelDescription"></div>
            <button id="compressBtn" class="btn btn-primary btn-large" style="width:100%;margin-top:2rem;font-size:1.15rem;">
                <i class="ti ti-arrows-minimize"></i> Compress PDF
            </button>
        </div>

        <div id="resultsSection" class="hidden" style="margin-top: 3rem;">
            <h2 style="margin-bottom: 2rem; font-size: 2rem; font-weight: 800; text-align: center;">Compressed PDFs</h2>
            <div id="resultsGrid" class="results-grid"></div>
            <div style="text-align:center;margin-top:2rem;">
                <button id="downloadAllBtn" class="btn btn-primary btn-large">
                    <i class="ti ti-download"></i> Download All
                </button>
            </div>
        </div>
    </div>

    <div class="ad-slot">Advertisement Space</div>
    <footer class="footer">
        <div class="footer-container">
            <div class="footer-column">
                <h3>DocLite</h3>
                <p class="footer-description">Free online document tools. Convert, compress, and optimize files directly in your browser.</p>
            </div>
            <div class="footer-column">
                <h3>Company</h3>
                <ul class="footer-links">
                    <li><a href="../about.html" class="footer-link">About Us</a></li>
                    <li><a href="../contact.html" class="footer-link">Contact</a></li>
                    <li><a href="../terms.html" class="footer-link">Terms of Service</a></li>
                    <li><a href="../privacy.html" class="footer-link">Privacy Policy</a></li>
                </ul>
            </div>
        </div>
        <div class="footer-bottom">
            <h4>&copy; 2025 DocLite. All rights reserved.</h4>
        </div>
    </footer>

    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/pdf-lib/1.17.1/pdf-lib.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    <script defer src="../js/components.js"></script>
    <script>
        (function() {
            let files = [];
            const { PDFDocument } = PDFLib;
            
            // Configure pdf.js worker
            if (typeof pdfjsLib !== 'undefined') {
                pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';
            }

            // Create upload area
            document.getElementById('uploadArea').appendChild(
                DocLiteComponents.createUploadArea({
                    accept: 'application/pdf',
                    multiple: true,
                    onFileSelect: (selectedFiles) => {
                        files = selectedFiles;
                        if (files.length) {
                            displayList();
                            document.getElementById('controlsSection').classList.remove('hidden');
                            document.getElementById('compressBtn').classList.remove('hidden');
                        }
                    }
                })
            );

            // Compression level profiles (11 zones)
            const levelProfiles = [
                { name: 'Lossless', factor: 1.0, floorKB: null, desc: 'Identical copy. No visual change.' },
                { name: 'Very High', factor: 0.85, floorKB: null, desc: 'Visually lossless. Fonts intact.' },
                { name: 'High', factor: 0.70, floorKB: null, desc: 'Great quality. Minor optimization.' },
                { name: 'Balanced', factor: 0.55, floorKB: null, desc: 'Good balance of size & clarity.' },
                { name: 'Standard', factor: 0.45, floorKB: null, desc: 'Readable text. Light image softening.' },
                { name: 'Medium', factor: 0.35, floorKB: null, desc: 'Noticeable shrink. Text remains sharp.' },
                { name: 'Strong', factor: 0.28, floorKB: null, desc: 'Strong reduction. Slight blur.' },
                { name: 'Aggressive', factor: 0.22, floorKB: null, desc: 'Aggressive. Images softer.' },
                { name: 'Extreme', factor: 0.18, floorKB: null, desc: 'Extreme compression. Trade-offs visible.' },
                { name: 'Ultra', factor: 0.14, floorKB: null, desc: 'Ultra small. Essential detail retained.' },
                { name: 'Minimum', factor: null, floorKB: 25, desc: 'Force down toward ~25KB if possible.' }
            ];
            let selectedLevel = 3; // Balanced default
            const levelsGrid = document.getElementById('levelsGrid');
            const levelDescription = document.getElementById('levelDescription');
            function renderLevels(){
                levelsGrid.innerHTML='';
                levelProfiles.forEach((lvl,idx)=>{
                    const el=document.createElement('div');
                    el.style.cssText=`background:#fff;border:2px solid ${idx===selectedLevel?'#667eea':'rgba(102,126,234,0.2)'};border-radius:16px;padding:1rem .75rem;display:flex;flex-direction:column;align-items:center;gap:.5rem;cursor:pointer;transition:.3s;box-shadow:${idx===selectedLevel?'0 8px 24px rgba(102,126,234,0.25)':'0 2px 6px rgba(0,0,0,0.06)'};`;
                    el.innerHTML=`<div style='font-weight:700;font-size:.95rem;color:${idx===selectedLevel?'#667eea':'#2d3748'};'>${lvl.name}</div><div style='font-size:.65rem;font-weight:600;color:${idx===selectedLevel?'#764ba2':'#718096'};letter-spacing:.5px;text-transform:uppercase;'>${lvl.floorKB? (lvl.floorKB+' KB floor') : (Math.round(lvl.factor*100)+'% target')}</div>`;
                    if(idx===selectedLevel){ el.style.background='linear-gradient(135deg, rgba(102,126,234,0.08) 0%, rgba(118,75,162,0.08) 100%)'; }
                    el.onmouseenter=()=>{ if(idx!==selectedLevel){ el.style.transform='translateY(-4px)'; el.style.borderColor='#667eea'; } };
                    el.onmouseleave=()=>{ if(idx!==selectedLevel){ el.style.transform='translateY(0)'; el.style.borderColor='rgba(102,126,234,0.2)'; } };
                    el.onclick=()=>{ selectedLevel=idx; renderLevels(); updateDescription(); };
                    levelsGrid.appendChild(el);
                });
            }
            function updateDescription(){ const p=levelProfiles[selectedLevel]; levelDescription.innerHTML=`<span style='display:inline-flex;align-items:center;gap:.4rem;'><i class='ti ti-info-circle' style='color:#667eea'></i><strong>${p.name}:</strong> ${p.desc}</span>`; }
            renderLevels(); updateDescription();

            function displayList() {
                const section = document.getElementById('fileListSection');
                section.innerHTML = '';
                section.appendChild(
                    DocLiteComponents.createFileList(files, {
                        onRemove: (index) => {
                            files.splice(index, 1);
                            if (files.length) {
                                displayList();
                            } else {
                                section.classList.add('hidden');
                                document.getElementById('compressBtn').classList.add('hidden');
                            }
                        },
                        onRemoveAll: () => {
                            files = [];
                            section.classList.add('hidden');
                            document.getElementById('controlsSection').classList.add('hidden');
                            document.getElementById('compressBtn').classList.add('hidden');
                        }
                    })
                );
                section.classList.remove('hidden');
            }

            document.getElementById('compressBtn').onclick = async () => {
                try {
                    DocLiteComponents.showLoading('Compressing PDFs... This may take a moment.');
                    const results = [];
                    const profile = levelProfiles[selectedLevel];
                    
                    // Hide controls during compression
                    document.getElementById('controlsSection').style.opacity = '0.6';
                    document.getElementById('compressBtn').disabled = true;

                    for (const file of files) {
                        try {
                            const bytes = await file.arrayBuffer();
                            const originalSizeKB = (bytes.byteLength / 1024).toFixed(2);
                            const originalSizeBytes = bytes.byteLength;
                            let targetSizeBytes = profile.floorKB ? profile.floorKB*1024 : Math.max(25*1024, Math.round(originalSizeBytes*profile.factor));
                            const margin = targetSizeBytes * 0.1;
                            if (originalSizeBytes <= (targetSizeBytes + margin) && !profile.floorKB) {
                                // Skip compression - file is already at or below target
                                results.push({
                                    blob: new Blob([bytes], { type: 'application/pdf' }),
                                    filename: file.name,
                                    size: originalSizeBytes,
                                    sizeKB: originalSizeKB,
                                    reduction: 0,
                                    originalSize: originalSizeBytes,
                                    skipped: true
                                });
                                continue;
                            }
                            
                            const originalPdfDoc = await PDFDocument.load(bytes);
                            const pageCount = originalPdfDoc.getPageCount();
                            
                            // Load with pdf.js for rendering (renders ALL content: text, images, vectors)
                            const loadingTask = window.pdfjsLib.getDocument({ data: bytes });
                            const pdf = await loadingTask.promise;
                            
                            // Create new compressed PDF
                            const compressedPdf = await PDFDocument.create();
                            
                            // Derive starting parameters from selected level
                            let quality = profile.floorKB ? 0.40 : (0.6 + profile.factor*0.35);
                            let scale = profile.floorKB ? 0.55 : (0.7 + profile.factor*0.3);
                            let resolution = scale;
                            
                            // Render pages once (base pass)
                            const renderedPages = [];
                            for (let i = 1; i <= pageCount; i++) {
                                const page = await pdf.getPage(i);
                                const baseViewport = page.getViewport({ scale: 1.0 });
                                const viewport = page.getViewport({ scale: scale * resolution });
                                
                                // Create high-quality canvas
                                const canvas = document.createElement('canvas');
                                canvas.width = viewport.width;
                                canvas.height = viewport.height;
                                const ctx = canvas.getContext('2d', {
                                    alpha: false,
                                    willReadFrequently: false,
                                    desynchronized: true
                                });
                                
                                // Enable high-quality rendering
                                ctx.imageSmoothingEnabled = true;
                                ctx.imageSmoothingQuality = 'high';
                                ctx.textRendering = 'optimizeLegibility';
                                
                                // Crisp white background
                                ctx.fillStyle = '#FFFFFF';
                                ctx.fillRect(0, 0, canvas.width, canvas.height);
                                
                                // Render complete page with maximum quality
                                await page.render({
                                    canvasContext: ctx,
                                    viewport: viewport,
                                    intent: 'print',
                                    renderInteractiveForms: false,
                                    annotationMode: 0,
                                    enableWebGL: false,
                                    renderTextLayer: false,
                                    renderAnnotationLayer: false
                                }).promise;
                                
                                renderedPages.push({ canvas, baseViewport });
                            }
                            // Iterative quality reduction loop
                            let attemptQuality = quality;
                            let downScale = 1.0;
                            const minQuality = profile.floorKB ? 0.30 : 0.45;
                            let finalBytes = null;
                            let loops = 0;
                            while(loops < 12){
                                const tempPdf = await PDFDocument.create();
                                for(const rp of renderedPages){
                                    let workCanvas = rp.canvas;
                                    if(downScale < 1.0){
                                        const sc=document.createElement('canvas');
                                        sc.width=Math.round(workCanvas.width*downScale);
                                        sc.height=Math.round(workCanvas.height*downScale);
                                        const sctx=sc.getContext('2d');
                                        sctx.imageSmoothingEnabled=true; sctx.imageSmoothingQuality='high';
                                        sctx.drawImage(workCanvas,0,0,sc.width,sc.height);
                                        workCanvas=sc;
                                    }
                                    const data=workCanvas.toDataURL('image/jpeg', attemptQuality);
                                    const imgBytes=Uint8Array.from(atob(data.split(',')[1]),c=>c.charCodeAt(0));
                                    const image=await tempPdf.embedJpg(imgBytes);
                                    const p=tempPdf.addPage([rp.baseViewport.width, rp.baseViewport.height]);
                                    p.drawImage(image,{x:0,y:0,width:rp.baseViewport.width,height:rp.baseViewport.height});
                                }
                                const out=await tempPdf.save({useObjectStreams:true,addDefaultPage:false});
                                finalBytes=out;
                                if(out.length <= targetSizeBytes || attemptQuality <= minQuality){
                                    if(out.length > targetSizeBytes && downScale > 0.65){
                                        downScale -= 0.08; attemptQuality = Math.max(minQuality, attemptQuality - 0.03); loops++; continue;
                                    }
                                    break;
                                }
                                attemptQuality -= 0.05;
                                if(attemptQuality < minQuality && downScale > 0.75){ downScale -= 0.1; }
                                loops++;
                            }
                            const finalSize = finalBytes.length;
                            const originalSize = bytes.byteLength;
                            const finalSizeKB = (finalSize/1024).toFixed(2);
                            const reduction = finalSize >= originalSize ? 0 : ((1 - finalSize/originalSize)*100).toFixed(1);
                            results.push({ blob:new Blob([finalBytes],{type:'application/pdf'}), filename:file.name, size:finalSize, sizeKB:finalSizeKB, reduction, originalSize });
                        } catch (error) {
                            console.error(`Error compressing ${file.name}:`, error);
                            alert(`Failed to compress ${file.name}: ${error.message}`);
                        }
                    }

                    // Display results with clean UI
                    const grid = document.getElementById('resultsGrid');
                    grid.innerHTML = '';
                    
                    results.forEach((result, index) => {
                        const div = document.createElement('div');
                        div.className = 'result-item';
                        
                        // Determine size color and status
                        const currentSizeKB = parseFloat(result.sizeKB);
                        let tgtBytes = profile.floorKB ? profile.floorKB*1024 : Math.max(25*1024, Math.round(result.originalSize*profile.factor));
                        const tgtKB = (tgtBytes/1024).toFixed(2);
                        const sizeColor = currentSizeKB <= parseFloat(tgtKB) ? '#10b981' : '#f59e0b';
                        const originalSizeKB = (result.originalSize / 1024).toFixed(2);
                        
                        // Check if skipped
                        if (result.skipped) {
                            div.innerHTML = `
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <i class="ti ti-file-description" style="font-size: 3.5rem; color: #667eea;"></i>
                                </div>
                                <div class="result-filename" style="font-weight: 700; font-size: 1rem; margin-bottom: 1.25rem; word-break: break-word; line-height: 1.4;">
                                    ${result.filename}
                                </div>
                                <div style="text-align:center;margin:1.25rem 0;">
                                    <div style="font-size:0.9rem;color:#718096;margin-bottom:0.5rem;font-weight:600;">
                                        Target: ${tgtKB} KB â†’ <span style="color:#10b981;font-weight:700;font-size:1.1rem;">${result.sizeKB} KB</span>
                                    </div>
                                    <div style="font-size:0.85rem;color:#10b981;font-weight:600;">
                                        <i class="ti ti-circle-check"></i> Already optimized
                                    </div>
                                </div>
                                <button class="btn btn-primary" style="width: 100%; padding: 0.875rem 1.5rem; font-size: 1rem; font-weight: 700;">
                                    <i class="ti ti-download"></i>
                                    Download
                                </button>
                            `;
                        } else {
                            div.innerHTML = `
                                <div style="text-align: center; margin-bottom: 1rem;">
                                    <i class="ti ti-file-description" style="font-size: 3.5rem; color: #667eea;"></i>
                                </div>
                                <div class="result-filename" style="font-weight: 700; font-size: 1rem; margin-bottom: 1.25rem; word-break: break-word; line-height: 1.4;">
                                    ${result.filename}
                                </div>
                                <div style="text-align:center;margin:1.25rem 0;">
                                    <div style="font-size:0.9rem;color:#718096;margin-bottom:0.5rem;font-weight:600;">
                                        Target: ${tgtKB} KB â†’ <span style="color:${sizeColor};font-weight:700;font-size:1.1rem;">${result.sizeKB} KB</span>
                                    </div>
                                    ${result.reduction > 0 
                                        ? `<div style="font-size:0.85rem;color:#10b981;font-weight:600;">
                                            <i class="ti ti-arrow-down"></i> ${result.reduction}% smaller
                                           </div>`
                                        : `<div style="font-size:0.85rem;color:#ef4444;font-weight:600;">
                                            <i class="ti ti-alert-circle"></i> Larger than original
                                           </div>`
                                    }
                                </div>
                                <button class="btn btn-primary" style="width: 100%; padding: 0.875rem 1.5rem; font-size: 1rem; font-weight: 700;">
                                    <i class="ti ti-download"></i>
                                    Download
                                </button>
                            `;
                        }
                        
                        div.querySelector('button').onclick = () => {
                            DocLiteComponents.downloadFile(result.blob, result.filename);
                        };
                        
                        // Add with animation
                        div.style.opacity = '0';
                        div.style.transform = 'translateY(20px)';
                        grid.appendChild(div);
                        
                        setTimeout(() => {
                            div.style.transition = 'all 0.4s ease';
                            div.style.opacity = '1';
                            div.style.transform = 'translateY(0)';
                        }, index * 50);
                    });

                    const resultsSection = document.getElementById('resultsSection');
                    resultsSection.classList.remove('hidden');
                    
                    // Restore controls
                    document.getElementById('controlsSection').style.opacity = '1';
                    document.getElementById('compressBtn').disabled = false;
                    
                    // Smooth scroll to results
                    setTimeout(() => {
                        resultsSection.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, 100);
                    
                    document.getElementById('downloadAllBtn').onclick = () => {
                        DocLiteComponents.downloadAsZip(results, 'compressed-pdfs.zip');
                    };

                    DocLiteComponents.hideLoading();
                } catch (error) {
                    console.error('Compression error:', error);
                    alert('Error compressing PDF: ' + error.message);
                    document.getElementById('controlsSection').style.opacity = '1';
                    document.getElementById('compressBtn').disabled = false;
                    DocLiteComponents.hideLoading();
                }
            };
        })();
    </script>
</body>
</html>





